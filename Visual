-- Visual Module (ESP) - Auto-scaling Box ESP with Type Decals
-- This creates the UI for the Visual tab

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

local VisualModule = {}
VisualModule.Settings = {
    Enabled = false,
    Box = false,
    Name = false,
    Type = false,
    TeamCheck = false,
    Health = false
}

local ESPObjects = {}
local lastUpdateTime = 0
local espUpdateConnection = nil
local checkboxStates = {}
local espToggleButton = nil

-- Type decal IDs
local TypeDecals = {
    Bomber = "rbxassetid://106785426779694",
    Rusher = "rbxassetid://652345103",
    Cannoner = "rbxassetid://5834509428",
    Hunter = "rbxassetid://14244367874",
    Gravedigger = "rbxassetid://90297495789346",
    Gladiator = "rbxassetid://7097554699"
}

local function getPlayerType(character)
    local tools = {"Bomb", "GravediggerPickaxe", "GladiatorsSword", "Cannon", "HuntersBow", "HuntersPunch", "Dynamite"}
    local typeMap = {
        Bomb = "Bomber",
        GravediggerPickaxe = "Gravedigger",
        GladiatorsSword = "Gladiator",
        Cannon = "Cannoner",
        HuntersBow = "Hunter",
        HuntersPunch = "Hunter",
        Dynamite = "Rusher"
    }
    
    for _, toolName in ipairs(tools) do
        if character:FindFirstChild(toolName) then
            return typeMap[toolName]
        end
    end
    return "None"
end

local function getTeamColor(player)
    if player.Team and player.Team.TeamColor then
        return player.Team.TeamColor.Color
    end
    return Color3.fromRGB(255, 255, 255)
end

local function hideAllESP(player)
    if not ESPObjects[player] then return end
    local data = ESPObjects[player]
    
    -- Hide box holder
    if data.boxHolder then
        pcall(function() 
            for _, box in pairs(data.boxHolder:GetChildren()) do
                box.Visible = false
            end
        end)
    end
    
    -- Hide text labels and images
    if data.folder then
        for _, child in pairs(data.folder:GetChildren()) do
            if child:IsA("BillboardGui") then
                pcall(function() child.Enabled = false end)
            end
        end
    end
end

local function createBoxes(character, holder, teamColor)
    -- Clear existing boxes
    for _, child in pairs(holder:GetChildren()) do
        child:Destroy()
    end
    
    -- Create box for each body part
    for _, part in ipairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            local box = Instance.new("BoxHandleAdornment")
            box.Adornee = part
            box.Size = part.Size
            box.Color3 = teamColor
            box.AlwaysOnTop = true
            box.ZIndex = 10
            box.Transparency = 0.6
            box.Visible = true
            box.Parent = holder
        end
    end
end

local function createESP(player)
    if player == Players.LocalPlayer then return end
    if ESPObjects[player] then return end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "ESP_" .. player.Name
    espFolder.Parent = CoreGui
    
    -- Create box holder
    local boxHolder = Instance.new("Folder")
    boxHolder.Name = "BoxHolder"
    boxHolder.Parent = espFolder
    
    ESPObjects[player] = {
        folder = espFolder,
        boxHolder = boxHolder
    }
end

local function updateESP(player)
    if not ESPObjects[player] then return end
    
    if not VisualModule.Settings.Enabled then 
        hideAllESP(player)
        return 
    end
    
    local character = player.Character
    if not character then 
        hideAllESP(player)
        return 
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    local torso = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso")
    
    if not rootPart or not humanoid then 
        hideAllESP(player)
        return 
    end
    
    local data = ESPObjects[player]
    if not data then return end
    
    -- Team Check
    local shouldHide = false
    if VisualModule.Settings.TeamCheck then
        if player.Team and Players.LocalPlayer.Team and player.Team == Players.LocalPlayer.Team then
            shouldHide = true
        end
    end
    
    if shouldHide then
        hideAllESP(player)
        return
    end
    
    -- Box ESP with auto-scaling
    if VisualModule.Settings.Box and data.boxHolder then
        -- Check if boxes need to be created/updated
        local needsUpdate = data.boxHolder:GetChildren()[1] == nil
        
        if needsUpdate then
            local teamColor = getTeamColor(player)
            createBoxes(character, data.boxHolder, teamColor)
        else
            -- Update visibility and color
            local teamColor = getTeamColor(player)
            for _, box in pairs(data.boxHolder:GetChildren()) do
                if box:IsA("BoxHandleAdornment") then
                    box.Color3 = teamColor
                    box.Visible = true
                end
            end
        end
    else
        if data.boxHolder then
            for _, box in pairs(data.boxHolder:GetChildren()) do
                pcall(function() box.Visible = false end)
            end
        end
    end
    
    -- Name ESP - Higher priority, 1 stud above head
    local nameLabel = data.folder:FindFirstChild("NameLabel")
    if VisualModule.Settings.Name then
        if not nameLabel then
            nameLabel = Instance.new("BillboardGui")
            nameLabel.Name = "NameLabel"
            nameLabel.Size = UDim2.new(0, 200, 0, 50)
            nameLabel.StudsOffset = Vector3.new(0, 4, 0)
            nameLabel.AlwaysOnTop = true
            nameLabel.Parent = data.folder
            
            local textLabel = Instance.new("TextLabel")
            textLabel.Name = "Text"
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            textLabel.TextStrokeTransparency = 0.5
            textLabel.Font = Enum.Font.GothamBold
            textLabel.TextSize = 14
            textLabel.ZIndex = 10
            textLabel.Parent = nameLabel
        end
        nameLabel.Adornee = rootPart
        nameLabel.StudsOffset = Vector3.new(0, 4, 0)
        local textLabel = nameLabel:FindFirstChild("Text")
        if textLabel then 
            textLabel.Text = player.Name 
            textLabel.ZIndex = 10
        end
        nameLabel.Enabled = true
    else
        if nameLabel then 
            pcall(function() nameLabel.Enabled = false end)
        end
    end
    
    -- Type ESP - Show decal image on torso
    local typeLabel = data.folder:FindFirstChild("TypeLabel")
    local playerType = getPlayerType(character)
    
    if VisualModule.Settings.Type and playerType ~= "None" then
        if not typeLabel then
            typeLabel = Instance.new("BillboardGui")
            typeLabel.Name = "TypeLabel"
            typeLabel.Size = UDim2.new(0, 100, 0, 100)
            typeLabel.StudsOffset = Vector3.new(0, 0, 0)
            typeLabel.AlwaysOnTop = true
            typeLabel.Parent = data.folder
            
            local imageLabel = Instance.new("ImageLabel")
            imageLabel.Name = "TypeImage"
            imageLabel.Size = UDim2.new(1, 0, 1, 0)
            imageLabel.BackgroundTransparency = 1
            imageLabel.ScaleType = Enum.ScaleType.Fit
            imageLabel.ZIndex = 1
            imageLabel.Parent = typeLabel
        end
        
        if torso then
            typeLabel.Adornee = torso
        else
            typeLabel.Adornee = rootPart
        end
        
        typeLabel.StudsOffset = Vector3.new(0, 0, 0)
        local imageLabel = typeLabel:FindFirstChild("TypeImage")
        if imageLabel and TypeDecals[playerType] then
            imageLabel.Image = TypeDecals[playerType]
            imageLabel.ZIndex = 1
        end
        typeLabel.Enabled = true
    else
        if typeLabel then 
            pcall(function() typeLabel.Enabled = false end)
        end
    end
    
    -- Health ESP
    local healthLabel = data.folder:FindFirstChild("HealthLabel")
    if VisualModule.Settings.Health then
        if not healthLabel then
            healthLabel = Instance.new("BillboardGui")
            healthLabel.Name = "HealthLabel"
            healthLabel.Size = UDim2.new(0, 200, 0, 50)
            healthLabel.StudsOffset = Vector3.new(0, 2.5, 0)
            healthLabel.AlwaysOnTop = true
            healthLabel.Parent = data.folder
            
            local textLabel = Instance.new("TextLabel")
            textLabel.Name = "Text"
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            textLabel.TextStrokeTransparency = 0.5
            textLabel.Font = Enum.Font.GothamBold
            textLabel.TextSize = 12
            textLabel.ZIndex = 5
            textLabel.Parent = healthLabel
        end
        healthLabel.Adornee = rootPart
        healthLabel.StudsOffset = Vector3.new(0, 2.5, 0)
        local textLabel = healthLabel:FindFirstChild("Text")
        if textLabel then 
            textLabel.Text = math.floor(humanoid.Health) .. "/" .. math.floor(humanoid.MaxHealth)
            textLabel.ZIndex = 5
        end
        healthLabel.Enabled = true
    else
        if healthLabel then 
            pcall(function() healthLabel.Enabled = false end)
        end
    end
end

local function updateAllESP()
    local currentTime = tick()
    if currentTime - lastUpdateTime < 10 then return end
    lastUpdateTime = currentTime
    
    for player, data in pairs(ESPObjects) do
        if not Players:FindFirstChild(player.Name) then
            if data.folder then 
                pcall(function() data.folder:Destroy() end)
            end
            ESPObjects[player] = nil
        else
            pcall(function() updateESP(player) end)
        end
    end
end

local function toggleESP(enabled)
    VisualModule.Settings.Enabled = enabled
    
    if enabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                createESP(player)
                pcall(function() updateESP(player) end)
            end
        end
        
        if not espUpdateConnection then
            espUpdateConnection = RunService.Heartbeat:Connect(function()
                pcall(updateAllESP)
            end)
        end
    else
        for player, data in pairs(ESPObjects) do
            hideAllESP(player)
        end
        
        if espUpdateConnection then
            espUpdateConnection:Disconnect()
            espUpdateConnection = nil
        end
    end
end

-- Handle character respawns
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        task.wait(0.5)
        if VisualModule.Settings.Enabled and ESPObjects[player] then
            -- Recreate boxes for new character
            local teamColor = getTeamColor(player)
            createBoxes(character, ESPObjects[player].boxHolder, teamColor)
            pcall(function() updateESP(player) end)
        end
    end)
    
    task.wait(1)
    if VisualModule.Settings.Enabled then
        createESP(player)
    end
end)

-- Handle existing players' respawns
for _, player in pairs(Players:GetPlayers()) do
    if player ~= Players.LocalPlayer then
        player.CharacterAdded:Connect(function(character)
            task.wait(0.5)
            if VisualModule.Settings.Enabled and ESPObjects[player] then
                local teamColor = getTeamColor(player)
                createBoxes(character, ESPObjects[player].boxHolder, teamColor)
                pcall(function() updateESP(player) end)
            end
        end)
    end
end

function VisualModule.CreateUI(parent)
    local visualContent = Instance.new("ScrollingFrame")
    visualContent.Name = "VisualContent"
    visualContent.Size = UDim2.new(1, -20, 1, -20)
    visualContent.Position = UDim2.new(0, 10, 0, 10)
    visualContent.BackgroundTransparency = 1
    visualContent.BorderSizePixel = 0
    visualContent.ScrollBarThickness = 4
    visualContent.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    visualContent.Parent = parent
    
    local function createCheckbox(name, settingKey, yPos)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 30)
        container.Position = UDim2.new(0, 10, 0, yPos)
        container.BackgroundTransparency = 1
        container.Parent = visualContent
        
        local checkbox = Instance.new("TextButton")
        checkbox.Size = UDim2.new(0, 20, 0, 20)
        checkbox.Position = UDim2.new(0, 0, 0, 5)
        checkbox.BackgroundColor3 = Color3.fromRGB(124, 124, 124)
        checkbox.BackgroundTransparency = 0.3
        checkbox.BorderSizePixel = 1
        checkbox.BorderColor3 = Color3.fromRGB(255, 255, 255)
        checkbox.Text = ""
        checkbox.AutoButtonColor = false
        checkbox.Parent = container
        
        local checkmark = Instance.new("TextLabel")
        checkmark.Size = UDim2.new(1, 0, 1, 0)
        checkmark.BackgroundTransparency = 1
        checkmark.Text = ""
        checkmark.Font = Enum.Font.GothamBlack
        checkmark.TextSize = 16
        checkmark.TextColor3 = Color3.fromRGB(255, 255, 255)
        checkmark.Parent = checkbox
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -30, 0, 30)
        label.Position = UDim2.new(0, 30, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextStrokeTransparency = 1
        label.Parent = container
        
        checkbox.MouseButton1Click:Connect(function()
            VisualModule.Settings[settingKey] = not VisualModule.Settings[settingKey]
            checkmark.Text = VisualModule.Settings[settingKey] and "âœ“" or ""
            
            lastUpdateTime = 0
            for player, data in pairs(ESPObjects) do
                pcall(function() updateESP(player) end)
            end
        end)
    end
    
    local function createToggleButton(name, yPos)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, yPos)
        container.BackgroundTransparency = 1
        container.Parent = visualContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.4, -10, 0, 40)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 16
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.TextStrokeTransparency = 1
        label.Parent = container
        
        local toggleButton = Instance.new("TextButton")
        toggleButton.Size = UDim2.new(0, 140, 0, 40)
        toggleButton.Position = UDim2.new(1, -140, 0, 5)
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
        toggleButton.BackgroundTransparency = 0
        toggleButton.BorderSizePixel = 0
        toggleButton.Text = "DISABLED"
        toggleButton.Font = Enum.Font.GothamBlack
        toggleButton.TextSize = 14
        toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        toggleButton.TextStrokeTransparency = 1
        toggleButton.AutoButtonColor = false
        toggleButton.Parent = container
        
        espToggleButton = toggleButton
        
        toggleButton.MouseButton1Click:Connect(function()
            local newState = not VisualModule.Settings.Enabled
            toggleESP(newState)
            
            if VisualModule.Settings.Enabled then
                toggleButton.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
                toggleButton.Text = "ENABLED"
            else
                toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
                toggleButton.Text = "DISABLED"
            end
        end)
    end
    
    createToggleButton("ESP Types", 10)
    createCheckbox("Box", "Box", 70)
    createCheckbox("Name", "Name", 110)
    createCheckbox("Type", "Type", 150)
    createCheckbox("Team check", "TeamCheck", 190)
    createCheckbox("Health", "Health", 230)
    
    visualContent.CanvasSize = UDim2.new(0, 0, 0, 280)
end

function VisualModule.Cleanup()
    if espUpdateConnection then
        espUpdateConnection:Disconnect()
        espUpdateConnection = nil
    end
    for player, data in pairs(ESPObjects) do
        if data.folder then 
            pcall(function() data.folder:Destroy() end)
        end
    end
    ESPObjects = {}
end

Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        if ESPObjects[player].folder then
            pcall(function() ESPObjects[player].folder:Destroy() end)
        end
        ESPObjects[player] = nil
    end
end)

return VisualModule
